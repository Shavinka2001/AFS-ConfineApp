name: Confine AKS CI-CD

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
  TAG: ${{ github.sha }}
  NAMESPACE: confine-prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
    # 1️⃣ Checkout
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2️⃣ Azure Login (Service Principal – separate secrets)
    - name: Azure Login
      uses: azure/login@v2
      with:
        auth-type: SERVICE_PRINCIPAL
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      env:
        AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}

    # 3️⃣ Login to ACR
    - name: ACR Login
      run: |
        az acr login --name ${{ secrets.ACR_NAME }}

    # 4️⃣ Build & Push Docker Images
    - name: Build & Push Images
      run: |
        docker build -t $REGISTRY/client:$TAG ./client
        docker build -t $REGISTRY/auth-service:$TAG ./services/auth
        docker build -t $REGISTRY/location-service:$TAG ./services/locationManagement
        docker build -t $REGISTRY/workorder-service:$TAG ./services/workOrderManagement

        docker push $REGISTRY/client:$TAG
        docker push $REGISTRY/auth-service:$TAG
        docker push $REGISTRY/location-service:$TAG
        docker push $REGISTRY/workorder-service:$TAG

    # 5️⃣ Get AKS context
    - name: Set AKS Context
      run: |
        az aks get-credentials \
          --resource-group ${{ secrets.AKS_RG }} \
          --name ${{ secrets.AKS_NAME }} \
          --overwrite-existing

    # 6️⃣ Ensure Namespace Exists
    - name: Ensure Namespace
      run: |
        kubectl get ns $NAMESPACE || kubectl create ns $NAMESPACE

    # 7️⃣ Create / Update Kubernetes Secrets
    - name: Apply Kubernetes Secrets
      run: |
        kubectl create secret generic confine-secrets \
          -n $NAMESPACE \
          --from-literal=MONGODB_URI="${{ secrets.MONGODB_URI }}" \
          --from-literal=JWT_SECRET="${{ secrets.JWT_SECRET }}" \
          --dry-run=client -o yaml | kubectl apply -f -

    # 8️⃣ Inject Image Tags
    - name: Inject Image Tags
      run: |
        find confine-k8s -type f -name "*.yaml" \
        -exec sed -i "s/IMAGE_TAG/$TAG/g" {} \;

    # 9️⃣ Deploy to AKS
    - name: Deploy to AKS
      run: |
        kubectl apply -f confine-k8s/
